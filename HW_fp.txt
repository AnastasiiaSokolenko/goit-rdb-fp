

-- 1. Створення схеми та перевірка кількості імпортованих записів

CREATE SCHEMA IF NOT EXISTS pandemic;
USE pandemic;

SELECT COUNT(*) AS raw_rows_count
FROM infectious_cases;


-- 2. Нормалізуйте таблицю infectious_cases до 3ї нормальної форми.
-- Збережіть у цій же схемі дві таблиці з нормалізованими даними.


-- Створення довідникової таблиці locations (унікальні комбінації entity та code)

CREATE TABLE IF NOT EXISTS locations (
    location_id INT AUTO_INCREMENT PRIMARY KEY,
    entity VARCHAR(150) NOT NULL,
    code VARCHAR(20) NULL,
    UNIQUE KEY uq_entity_code (entity, code)
);


-- Заповнення таблиці locations унікальними значеннями

INSERT IGNORE INTO locations (entity, code)
SELECT DISTINCT
    TRIM(entity) AS entity,
    NULLIF(TRIM(code), '') AS code
FROM infectious_cases;


-- Створення нормалізованої таблиці infectious_cases_norm

CREATE TABLE IF NOT EXISTS infectious_cases_norm (
    case_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    location_id INT NOT NULL,
    year INT NOT NULL,

    number_yaws INT NULL,
    polio_cases INT NULL,
    cases_guinea_worm INT NULL,
    number_smallpox INT NULL,
    number_cholera_cases INT NULL,

    number_rabies DECIMAL(18,8) NULL,
    number_malaria DECIMAL(18,8) NULL,
    number_hiv DECIMAL(18,8) NULL,
    number_tuberculosis DECIMAL(18,8) NULL,

    CONSTRAINT fk_cases_location
        FOREIGN KEY (location_id)
        REFERENCES locations(location_id)
);


-- Заповнення нормалізованої таблиці з очищенням даних 
-- (видалення пробілів, заміна порожніх значень на NULL та приведення до числових типів)

INSERT INTO infectious_cases_norm (
    location_id,
    year,
    number_yaws,
    polio_cases,
    cases_guinea_worm,
    number_smallpox,
    number_cholera_cases,
    number_rabies,
    number_malaria,
    number_hiv,
    number_tuberculosis
)
SELECT
    l.location_id,
    CAST(NULLIF(TRIM(ic.year), '') AS UNSIGNED),

    CAST(NULLIF(TRIM(ic.number_yaws), '') AS UNSIGNED),
    CAST(NULLIF(TRIM(ic.polio_cases), '') AS UNSIGNED),
    CAST(NULLIF(TRIM(ic.cases_guinea_worm), '') AS UNSIGNED),
    CAST(NULLIF(TRIM(ic.number_smallpox), '') AS UNSIGNED),
    CAST(NULLIF(TRIM(ic.number_cholera_cases), '') AS UNSIGNED),

    CAST(NULLIF(REPLACE(TRIM(ic.number_rabies), ',', '.'), '') AS DECIMAL(18,8)),
    CAST(NULLIF(REPLACE(TRIM(ic.number_malaria), ',', '.'), '') AS DECIMAL(18,8)),
    CAST(NULLIF(REPLACE(TRIM(ic.number_hiv), ',', '.'), '') AS DECIMAL(18,8)),
    CAST(NULLIF(REPLACE(TRIM(ic.number_tuberculosis), ',', '.'), '') AS DECIMAL(18,8))

FROM infectious_cases ic
JOIN locations l
  ON l.entity = TRIM(ic.entity)
 AND (
        (l.code IS NULL AND NULLIF(TRIM(ic.code), '') IS NULL)
     OR l.code = NULLIF(TRIM(ic.code), '')
     );


-- Перевірка результатів нормалізації

SELECT COUNT(*) AS normalized_rows
FROM infectious_cases_norm;

-- Перевірочний JOIN для візуального контролю даних

SELECT
    l.entity,
    l.code,
    ic.year,
    ic.number_yaws,
    ic.number_rabies,
    ic.polio_cases,
    ic.number_smallpox,
    ic.number_cholera_cases,
    ic.number_malaria,
    ic.number_hiv,
    ic.number_tuberculosis
FROM infectious_cases_norm ic
JOIN locations l ON l.location_id = ic.location_id
LIMIT 100;



-- 3. Аналіз показників number_rabies по кожній локації

SELECT
    l.location_id,
    l.entity,
    l.code,

    AVG(n.number_rabies) AS avg_rabies,
    MIN(n.number_rabies) AS min_rabies,
    MAX(n.number_rabies) AS max_rabies,
    SUM(n.number_rabies) AS sum_rabies
FROM infectious_cases_norm n
JOIN locations l
    ON l.location_id = n.location_id
    
-- Фільтрація порожніх значень (NULL)
WHERE n.number_rabies IS NOT NULL
GROUP BY
    l.location_id
ORDER BY
    avg_rabies DESC
LIMIT 10;



-- 4. Побудова дати 1 січня відповідного року та різниці в роках

SELECT
    year,

    -- Створення дати 1 січня відповідного року
    STR_TO_DATE(CONCAT(year, '-01-01'), '%Y-%m-%d') AS year_start_date,

    -- Поточна дата
    CURDATE() AS cur_date,

    -- Різниця в роках
    TIMESTAMPDIFF(
        YEAR,
        STR_TO_DATE(CONCAT(year, '-01-01'), '%Y-%m-%d'),
        CURDATE()
    ) AS year_difference

FROM infectious_cases_norm;



-- 5. Створення користувацької функції для обчислення різниці в роках 
-- (приймає рік, формує дату 01-01-YYYY та повертає різницю з поточною датою)

DELIMITER //

CREATE FUNCTION year_difference_func(input_year INT)
RETURNS INT
DETERMINISTIC
BEGIN
    RETURN TIMESTAMPDIFF(
        YEAR,
        STR_TO_DATE(CONCAT(input_year, '-01-01'), '%Y-%m-%d'),
        CURDATE()
    );
END //

DELIMITER ;


-- Використання функції для перевірки результату

SELECT
    year,
    year_difference_func(year) AS years_difference
FROM infectious_cases_norm;



